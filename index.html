<html>
  <head>
    <title>Sound Volume</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
    </style>
    <script src="build/three.js"></script>
    <script src="build/dat.gui.min.js"></script>
    <script src="build/stats.min.js"></script>
    <script src="build/OrbitControls.js"></script>
  </head>
  <script>
    //global variables
    var renderer;
    var scene;
    var camera;
    var control;
    var stats;

    //global variables - audio
    var context;
    var sourceNode;
    var analyser;
    var analyser2;

    function init() {
      //create the scene
      scene = new THREE.Scene();

      //add in the camera
      camera = new THREE.PerspectiveCamera(
        45,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );

      //create a renderer
      renderer = new THREE.WebGLRenderer();
      renderer.setClearColor(0xfed9d0, 1.0);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;

      // create the ground plane
      var planeGeometry = new THREE.PlaneGeometry(80, 80);
      var planeMaterial = new THREE.MeshPhongMaterial({color: 0xde2e6d});
      var plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.receiveShadow = true;

      // rotate and position the plane
      plane.rotation.x = -0.5 * Math.PI;
      plane.position.x = 0;
      plane.position.y = -2;
      plane.position.z = 0;

      // add the plane to the scene
      scene.add(plane);

      //create the particle system
      //1) create a cube
      var cubeGeometry = new THREE.BoxGeometry(3, 6, 3, 15, 25, 15);

      //2) create particles
      var pm = new THREE.PointsMaterial();
      pm.map = new THREE.TextureLoader().load("texture2.png");
      pm.blending = THREE.AdditiveBlending;
      pm.transparent = true;
      pm.size = 0.5;

      //3) create the particle system
      var ps = new THREE.Points(cubeGeometry, pm);
      ps.sortParticles = true;
      ps.name = "cube";
      ps.position.x = -1.75;
      scene.add(ps);

      //4) add the second particle system
      var pm2 = pm.clone();
      pm2.map = new THREE.TextureLoader().load("texture.png");
      //5) add the second particle system
      var ps2 = new THREE.Points(cubeGeometry, pm2);
      ps2.name = "cube2";
      ps2.position.x = 3;
      scene.add(ps2);

      // add spotlight for the shadows
      var spotLight = new THREE.SpotLight(0xfb9dc2);
      spotLight.position.set(10, 20, 20);
      spotLight.shadowCameraNear = 20;
      spotLight.shadowCameraFar = 50;
      spotLight.castShadow = true;

      scene.add(spotLight);

      //position camera
      camera.position.x = 10;
      camera.position.y = 14;
      camera.position.z = 10;
      camera.lookAt(scene.position);

      cameraControl = new THREE.OrbitControls(camera);

      document.body.appendChild(renderer.domElement);

      render();
    }

    function render() {
      renderer.render(scene, camera);
      requestAnimationFrame(render);

      cameraControl.update();
    }

    context = new AudioContext();

    //set up analyser
    analyser = context.createAnalyser();
    analyser.smoothingTimeConstant = 0.4;
    analyser.fftSize = 1024;

    //second channel analyser
    analyser2 = context.createAnalyser();
    analyser2.smoothingTimeConstant = 0.4;
    analyser.fftSize = 1024;

    //create buffer source node
    sourceNode = context.createBufferSource();
    var splitter = context.createChannelSplitter();

    //connect the source to the analyser and the splitter
    sourceNode.connect(splitter);

    //connect one of the outputs from the splitter to the analyser
    splitter.connect(analyser, 0);
    splitter.connect(analyser2, 1);

    //connect to destination
    sourceNode.connect(context.destination);

    context = new AudioContext();

    function loadSound(url) {
      var request = new XMLHttpRequest();
      request.open("GET", url, true);
    }

    function handleResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // calls the init function when the window is done loading.
    window.onload = init;
    // calls the handleResize function when the window is resized
    window.addEventListener("resize", handleResize, false);
  </script>
</html>
